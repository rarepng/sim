<!DOCTYPE html>
<html>
<body>
    <canvas id="canvas" width="800" height="600" style="border:1px solid black; background: #222;"></canvas>
    <script src="sim.js"></script>
    <script>
        Module().then(wasm => {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            const world = new wasm.PhysicsWorld(800, 600);
            
            for(let i=0; i<200; i++) {
                world.addParticle(
                    Math.random() * 800, 
                    Math.random() * 300, 
                    5 + Math.random() * 10
                );
            }

            function render() {
                world.update(0.016);

                const count = world.getParticleCount();
                const ptr = world.getParticlesPtr();
                
                // --- THE KEY PART ---
                // We access the Float32 view of the memory. 
                // We must grab this NEW every frame because if memory grows, the old buffer is invalid.
                const buffer = wasm.HEAPF32; 
                // --------------------

                const structSize = 32; 

                ctx.clearRect(0, 0, 800, 600);
                ctx.fillStyle = '#00ffcc';

                for(let i = 0; i < count; i++) {
                    // Divide by 4 because HEAPF32 is an array of floats (4 bytes each)
                    // but the pointer 'ptr' is in bytes.
                    const baseIndex = (ptr >> 2) + (i * (structSize >> 2));
                    
                    // If buffer is still undefined here, the compile flag didn't work.
                    const x = buffer[baseIndex];
                    const y = buffer[baseIndex + 1];
                    const r = buffer[baseIndex + 6];

                    ctx.beginPath();
                    ctx.arc(x, y, r, 0, 2 * Math.PI);
                    ctx.fill();
                }

                requestAnimationFrame(render);
            }

            render();
        });
    </script>
</body>
</html>